setup.users = {
    "ZeroRing233": {
        id: "ZeroRing233",
        username: "é›¶ç¯é›¶ç†æƒ³",
        attitude: ["supportive"],
        specialSpeech: ["å˜¿ï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é›¶ç¯",
            "å‘Šè¯‰ä½ ä»¬ä¸€ä¸ªç§˜å¯†ï¼Œæˆ‘æ˜¯è¿™ä¸ªç›´æ’­å¹³å°çš„ç®¡ç†å‘˜ï¼Œé‡åˆ°é—®é¢˜å¯ä»¥è”ç³»æˆ‘ï¼Œçœ‹åˆ°ä¾§è¾¹æ çš„è“è‰²çˆ±å¿ƒäº†å—ï¼Œé‚£é‡Œæœ‰æˆ‘çš„è”ç³»æ–¹å¼",
        ]
    },
    "benzene": {
        id: "benzene",
        username: "è‹¯ç¯",
        attitude: ["supportive"],
        specialSpeech: ["å¥½çœ‹çˆ±çœ‹âŒ¬Ï‰âŒ¬", 'ä¸»æ’­ä½ é‚£æ˜¯ä¸æ˜¯å¡äº†(>ï¹<)']
    },
    "random123": {
        id: "random123",
        username: "ç”¨æˆ·123",
        attitude: ["supportive", "neutral", "negative"],
        specialSpeech: []
    },
    "random456": {
        id: "random456",
        username: "ç”¨æˆ·456",
        attitude: ["supportive", "neutral", "negative"],
        specialSpeech: []
    },
    "random789": {
        id: "random789",
        username: "ç”¨æˆ·789",
        attitude: ["supportive", "neutral", "negative"],
        specialSpeech: []
    },
    "random123456": {
        id: "random123456",
        username: "ç”¨æˆ·123456",
        attitude: ["supportive", "neutral", "negative"],
        specialSpeech: []
    },
    "random2": {
        id: "random2",
        username: "æˆ‘æ˜¯å¥½çŒ«",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random3": {
        id: "random3",
        username: "æˆ‘æ˜¯åçŒ«",
        attitude: ["negative"],
        specialSpeech: []
    },
    "random4": {
        id: "random4",
        username: "å½©å½©å½©å½©å½©è™¹é©¬",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random5": {
        id: "random5",
        username: "æŠ¢ä¸åˆ°è‰è“çš„è›‹ç³•æ•™æˆ",
        attitude: ["supportive"],
        specialSpeech: ["ä¸»æ’­å¥½å¼ºå¥½å¯çˆ±ï¼Œå¯ä»¥åˆ†äº«ä¸‹ç»éªŒå—(Â´à®‡çš¿à®‡ï½€)"]
    },
    "random6": {
        id: "random6",
        username: "tuyuä¸¶æ¶‚é±¼ğŸŸ",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random7": {
        id: "random7",
        username: "å½­çŒ«çŒ«",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random8": {
        id: "random8",
        username: "èŠ‹æ³¥å†°æ²™",
        attitude: ["supportive", "neutral"],
        specialSpeech: []
    },
    "random9": {
        id: "random9",
        username: "åˆ©å£æ¹¾å¤§ä¸»æ•™",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random10": {
        id: "random10",
        username: "æŸ¥æŸ¥ä»Šå¤©å·¥ä½œäº†å—",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random11": {
        id: "random11",
        username: "ä»0å­¦ä»£ç åªä¸ºæŠŠé¥¼å˜ç°é¡ºä¾¿æˆ‘è¦ä¸­é—¨å¯¹ç‹™",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random12": {
        id: "random12",
        username: "ä»0å­¦ä»£ç åªä¸ºæŠŠé¥¼å˜ç°é¡ºä¾¿æˆ‘è¦ä¸­é—¨å¯¹ç‹™",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random13": {
        id: "random13",
        username: "ç¦»æ¸Š",
        attitude: ["neutral"],
        specialSpeech: []
    },
    "random14": {
        id: "random14",
        username: "æ˜¯é¦™èœä¸å«é¦™è‰",
        attitude: ["neutral"],
        specialSpeech: []
    },
    "random15": {
        id: "random15",
        username: "miyako4828",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "random16": {
        id: "random16",
        username: "é»æ˜ç ´æ™“",
        attitude: ["supportive"],
        specialSpeech: ["ä¸»æ’­å£°éŸ³çœŸå¥½å¬ï¼Œèƒ½å”±ä¸€é¦–æ­Œå—ï¼Ÿæƒ³å¤šå¬å¬ä¸»æ’­çš„å£°éŸ³ã€‚"]
    },
    "random17": {
        id: "random17",
        username: "ä¸€è¾†è½¦åˆ›äº†è¿‡æ¥",
        attitude: ["supportive"],
        specialSpeech: ["å¯¹ä¸èµ·åˆšæ‰å†²æ™•äº†è¿‡å»ï¼Œä¸»æ’­å¤ªå¯çˆ±äº†"]
    },
    "random18": {
        id: "random18",
        username: "Ca",
        attitude: ["supportive"],
        specialSpeech: ["æ„Ÿè§‰ä¸»æ’­çš„å£°éŸ³å¬èµ·æ¥å¥½æœ‰å®‰å…¨æ„Ÿï¼ä¸€å®šæ˜¯ä¸€ä½åœ¨ç”Ÿæ´»ä¸­ç‰¹åˆ«åŠªåŠ›çš„äººå§ï¼"]
    },
    "random19": {
        id: "random19",
        username: "Penuma",
        attitude: ["supportive"],
        specialSpeech: []
    },
    "headteacher": {
        id: "headteacher",
        username: "æ¸…æ­£å»‰æ´å¥½æ ¡é•¿",
        attitude: ["negative"],
        specialSpeech: ["ä½ ä»¬æ˜¯ï¼Ÿæ˜å¤©æ¥æˆ‘åŠå…¬å®¤ä¸€è¶Ÿ"]
    }
}

setup.random_msg = {
    supportive_list: ["è¿™é‡Œåœ¨æ’­ä»€ä¹ˆï¼Œå¥½çƒ­é—¹çš„æ ·å­ã€‚", "ä¸»æ’­çš„ç¬‘å®¹ï¼Œæ˜¯ä»Šå¤©æœ€æ¸©æš–çš„é˜³å…‰ï¼", "ä¸»æ’­ä¸»æ’­ï¼Œæ—è¾¹æ˜¯ä½ <<girlfriend>>å—ï¼Ÿ",
        "ä¸»æ’­åŠ æ²¹ï¼Œä½ çš„ç¬‘å®¹è¶…çº§æ²»æ„ˆï¼", "ä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼Œä¸»æ’­å¥½æ£’ï¼", "ç›´æ’­é—´çš„æ°›å›´å¤ªæ£’äº†ï¼Œæ¯æ¬¡æ¥éƒ½æ„Ÿè§‰å¾ˆæ¸©é¦¨ï¼", "è¢«ä¸»æ’­çš„çœŸè¯šæ‰“åŠ¨ï¼Œç»§ç»­åŠ æ²¹å“¦ï¼", "ç›´æ’­é—´æ°›å›´çœŸå¥½ï¼Œå¤§å®¶éƒ½å¥½å’Œè°ï¼", "çœ‹ä¸»æ’­ç›´æ’­ï¼Œå¿ƒæƒ…éƒ½å˜å¥½äº†ï¼", "æŠ€æœ¯æµä¸»æ’­ï¼Œçˆ±äº†çˆ±äº†ï¼Œç»§ç»­å‘å…‰å‘çƒ­å§ï¼", "æ¯æ¬¡çœ‹ä¸»æ’­ç›´æ’­éƒ½è§‰å¾—æ—¶é—´è¿‡å¾—å¥½å¿«ï¼", "ä¸»æ’­çš„ç¬‘å£°æ˜¯æˆ‘æ¯å¤©çš„å¿«ä¹æºæ³‰ï¼", "ç›´æ’­é—´çš„æœ‹å‹ä»¬éƒ½å¥½æœ‰çˆ±ï¼Œä¸€èµ·åŠ æ²¹ï¼",
        "ç»™ä¸»æ’­æ¯”å¿ƒå¿ƒ", "ä¸»æ’­å¥½åƒä¸€åªå°å°å°é¸Ÿå•Š", "ä¸»æ’­å¥½ç”¨å¿ƒ", "è¿™æ˜¯æˆ‘æœ€çˆ±çš„ä¸»æ’­", "å¤§å®¶éƒ½å¥½æœ‰å“å‘³", "\\ä¸»æ’­/\\ä¸»æ’­/\\ä¸»æ’­/", "ä»Šå¤©çš„ç›´æ’­å¤ªç²¾å½©äº†ï¼Œå®Œå…¨çœ‹ä¸å¤Ÿï¼"
    ],
    neutral_list: ["ä¸»æ’­ä¸»æ’­ï¼Œè¿™æ˜¯ç›´æ’­å—ï¼Ÿ", "åœ¨æ’­ä»€ä¹ˆå‘€ï¼Ÿ", 'ä¸é”™ï¼Œç»§ç»­çœ‹çœ‹ã€‚', "ä¸»æ’­åœ¨å¿™ä»€ä¹ˆå‘¢ï¼Ÿ", "çœ‹èµ·æ¥æŒºæœ‰è¶£çš„", "ç”»é¢æŒºæ¸…æ™°çš„", "ç›´æ’­æŒºæµç•…çš„", "èŠ‚å¥æŠŠæ¡å¾—ä¸é”™ã€‚", "æŒºæœ‰æ–°æ„çš„ç›´æ’­", "æœŸå¾…æ›´å¤šå†…å®¹", "å†…å®¹æœ‰ä¸€ç‚¹æ— èŠ", "å†…å®¹æœ‰ä¸€ç‚¹å¹³æ·¡", "è¿™ä¸æ˜¯æœ‰æ‰‹å°±è¡Œ", "ä¸»æ’­æœ‰ä¸€ç‚¹èœ", "æ„Ÿè§‰æˆ‘ä¸Šæˆ‘ä¹Ÿè¡Œ"],
    negative_list: ["è¿™æ’­å¾—æ˜¯ä»€ä¹ˆä¸œè¥¿", "æ— èŠï¼Œæ¥æ’­ç‚¹æ›´åˆºæ¿€çš„ä¸œè¥¿å§", "æŠŠä½ çš„è¡£æœè„±äº†", "åƒåœ¾ä¸»æ’­ï¼Œè¶æ—©æ”¹è¡Œå§", "å‚»X", "è„‘æ®‹ä¸»æ’­", "è£…ä»€ä¹ˆçº¯æ´å‘¢ï¼Œçœ‹çœ‹ä½ çš„"]
}

setup.randomrelfreq = function(array) {
    // accepts a strided array in form [thing, 20, thing, 80]
    // in order to make one thing 20% likely and the other 80% likely
    // or however you want to weight it, hence relative frequency
    // then returns the winning element

    let randomized = [...array];
    let sumsofar = 0;
    for (let i = 0; i < randomized.length; i += 2) {
        let factor = randomized[i + 1];
        factor = factor == 0 ? 1 : factor;
        sumsofar += factor;
        randomized[i + 1] = sumsofar;
    }

    let roll = this.rir(0, sumsofar);

    for (let i = 0; i < randomized.length; i += 2) {
        if (roll <= randomized[i + 1]) {
            return randomized[i];
        }
    }

    return randomized[0];
}

setup.rbg_from_string = function(name) {
    let hash = inthash(name).toString();

    while (hash.length < 9)
        hash += " ";

    let r = parseInt(hash.substring(0, 3));
    let g = parseInt(hash.substring(3, 6));
    let b = parseInt(hash.substring(6, 9));

    r = Math.trunc(128 + (128 * (r / 999)));
    g = Math.trunc(128 + (128 * (g / 999)));
    b = Math.trunc(128 + (128 * (b / 999)));

    return "rgb(" + r + ", " + g + ", " + b + ")";
}

const inthash = str => {
    let arr = str.split('');
    return Math.abs(arr.reduce(
        (hashCode, currentVal) =>
        (hashCode = currentVal.charCodeAt(0) + (hashCode << 6) + (hashCode << 16) - hashCode),
        0
    ));
};
setup.inthash = inthash;

setup.rir = function(min, max) {
    return Math.floor(State.random() * (max - min) + min);
}

Macro.add('streamscreen', {
    tags: null,
    handler: function() {
        $(this.output).wiki('<main class="streamscreen">' + this.payload[0].contents + '</main>');
    }
});

window.random_username = function(taken = []) {
    let name = null;
    while (!name || taken.includes(name))
        name = Object.keys(setup.users).random();
    return name;
}

function forbideClicked() {
    // å‡è®¾ä½ æœ‰ä¸€ä¸ªå…ƒç´ æ•°ç»„
    $(function() {
        let elements = document.querySelectorAll('.liveStreamForbide');
        console.log("å…ƒç´ æ•°ç»„é•¿åº¦æ˜¯" + elements.length)
            // å¾ªç¯é€šè¿‡å…ƒç´ æ•°ç»„ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶
        elements.forEach(function(element, index) {
            element.onclick = (function(fixedIndex) {
                return function() {
                    // åœ¨è¿™é‡Œå¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œä½¿ç”¨å›ºå®šå‚æ•°
                    onForbideClicked(element);
                };
            })(index); // è°ƒç”¨ç«‹å³æ‰§è¡Œå‡½æ•°å¹¶ä¼ é€’å½“å‰çš„indexä½œä¸ºå›ºå®šå‚æ•°
        });
    });
}
window.forbideClicked = forbideClicked;

function onForbideClicked(element) {
    let chatIndex = element.parentNode.previousElementSibling.innerText;
    chatIndex = parseInt(chatIndex);
    console.log("ç‚¹å‡»ç¦è¨€ï¼Œå½“å‰chatIndexæ˜¯" + chatIndex);
    let chatter = V.stream.chat[chatIndex];
    if (V.blacklist.includes(chatter.id)) {
        console.log("å½“å‰ç”¨æˆ·ã€Œ" + chatter.user + "ã€å·²è¢«ç¦è¨€ï¼Œé‡å¤ç‚¹å‡»æ— æ•ˆ");
        return;
    }
    let msg = "ç”¨æˆ·ã€Œ" + chatter.user + "ã€å·²è¢«ç®¡ç†å‘˜ç¦è¨€";
    let data = { "user": "ç³»ç»Ÿæ¶ˆæ¯", "id": "sysInfo", "text": msg, "attitude": "neutral" };
    V.blacklist.pushUnique(chatter.id);
    V.stream.chat.push(data);
    let index = V.stream.chat.length - 1
    let innerHTML = '<span class="streamchatIndex">' + index + '</span><span class="streamchatmsg"><span class="streamchatname" style="color: rgb(226, 191, 171)">ç³»ç»Ÿæ¶ˆæ¯ï¼š</span>' + msg + '</span><div class="streamchatsep">&nbsp;</div>'
    let parentElement = element.parentNode.parentNode;
    // console.log("ä¿®æ”¹å‰çš„innerHTMLæ˜¯" + parentElement.innerHTML)
    parentElement.innerHTML = parentElement.innerHTML + innerHTML;
    forbideClicked();
    deleteClicked();
}

// æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚æ€ä¹ˆå†™ç‹®å±±ï¼Œè½»ç‚¹åæ§½å•Šï¼Œè½»ç‚¹
function deleteClicked() {
    // å‡è®¾ä½ æœ‰ä¸€ä¸ªå…ƒç´ æ•°ç»„
    $(function() {
        let elements = document.querySelectorAll('.liveStreamDelete');
        console.log("å…ƒç´ æ•°ç»„é•¿åº¦æ˜¯" + elements.length)
            // å¾ªç¯é€šè¿‡å…ƒç´ æ•°ç»„ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶
        elements.forEach(function(element, index) {
            element.onclick = (function(fixedIndex) {
                return function() {
                    // åœ¨è¿™é‡Œå¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œä½¿ç”¨å›ºå®šå‚æ•°
                    //console.log("ç‚¹å‡»åˆ é™¤æˆåŠŸï¼å½“å‰indexæ˜¯" + fixedIndex)
                    onDeleteClicked(element);
                };
            })(index); // è°ƒç”¨ç«‹å³æ‰§è¡Œå‡½æ•°å¹¶ä¼ é€’å½“å‰çš„indexä½œä¸ºå›ºå®šå‚æ•°
        });
    });
}
window.deleteClicked = deleteClicked;

function onDeleteClicked(element) {
    // let elements = document.querySelectorAll('.liveStreamDelete');
    // let element = elements[fixedIndex];
    let chatIndex = element.parentNode.previousElementSibling.innerText;
    chatIndex = parseInt(chatIndex);
    console.log("ç‚¹å‡»åˆ é™¤ï¼Œå½“å‰chatIndexæ˜¯" + chatIndex);
    V.stream.chat.deleteAt(chatIndex);
    element.parentNode.nextElementSibling.remove();
    element.parentNode.remove();
}

function getAllPossibleUser() {
    // ä¹‹åè¦åšæ•™å¸ˆç»„äº’æ–¥å†…å®¹
    let userList = Object.keys(setup.users).filter(user => !V.blacklist.includes(user));
    return userList;
}
window.getAllPossibleUser = getAllPossibleUser;